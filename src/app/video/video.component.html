
<div class="video-container">
  <header class="video-header">
    <div class="header-content">
      <h1>ğŸ¯ Tracker Corporel en Temps RÃ©el</h1>
      <p>Analyse avancÃ©e de la posture, du visage et des mains</p>
    </div>
    <div class="header-stats">
      <div class="stat-item">
        <span class="stat-label">FPS</span>
        <span class="stat-value">{{ fps }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Status</span>
        <span class="stat-value">{{ isTracking ? 'ğŸ”´ LIVE' : 'âš« IDLE' }}</span>
      </div>
    </div>
  </header>

  <div class="main-content" [ngClass]="{ 'full-3d': showFull3DView }">
    <section class="video-section">
      <div class="video-upload-section" *ngIf="!isVideoInitialized && !videoUrl">
        <h3>ğŸ“¤ Charger une VidÃ©o</h3>
        <input type="file" (change)="onVideoFileSelected($event)" accept="video/*" />
        <button class="btn btn-primary" *ngIf="selectedVideoFile" (click)="processVideoFile()" [disabled]="isProcessingVideo">
          {{ isProcessingVideo ? 'Traitement en cours...' : 'Analyser la VidÃ©o' }}
        </button>
        <p class="upload-info">Ou utilisez la webcam ci-dessous</p>
      </div>
        
      <div class="image-upload-section" *ngIf="!isVideoInitialized && !videoUrl">
        <h3>ğŸ–¼ï¸ Charger une Image</h3>
        <input type="file" (change)="onImageFileSelected($event)" accept="image/*" />
        <button class="btn btn-primary" *ngIf="selectedImageFile" (click)="processImageFile()" [disabled]="isProcessingImage">
          {{ isProcessingImage ? 'Traitement en cours...' : 'Analyser l'Image' }}
        </button>
        <p class="upload-info">Ou utilisez la webcam ci-dessus</p>
      </div>
      
      <div class="video-wrapper">
        <!-- Display provided video URL if available -->
        <video *ngIf="videoUrl" [src]="videoUrl" controls class="video-stream" width="100%" height="400px"></video>
        <!-- Display camera video if no external URL provided -->
        <video *ngIf="!videoUrl" #videoElement class="video-stream" playsinline></video>
        <!-- Canvas for drawing body guides (pose, face, hands landmarks) -->
        <canvas #guideCanvas style="position: absolute; top: 0; left: 0; z-index: 10;"></canvas>
        <div class="fps-indicator" *ngIf="isTracking && !videoUrl">
          <span class="fps-badge">{{ fps }} FPS</span>
          <span class="recording-dot"></span>
        </div>
        <div class="error-message" *ngIf="errorMessage">
          <p>{{ errorMessage }}</p>
        </div>
      </div>

      <div class="video-controls">
        <!-- Show camera controls only when no external video URL is provided -->
        <button class="btn btn-primary" *ngIf="!videoUrl && !isVideoInitialized && !selectedVideoFile && !selectedImageFile" (click)="startCamera()">
          â–¶ï¸ DÃ©marrer (Webcam)
        </button>
        <button class="btn btn-secondary" *ngIf="!videoUrl && isVideoInitialized" (click)="stopCamera()">
          â¹ï¸ ArrÃªter
        </button>
        <button class="btn btn-info" *ngIf="!videoUrl && temporaryVideoBlob" (click)="downloadTemporaryVideo()">
          ğŸ“¥ TÃ©lÃ©charger VidÃ©o
        </button>
        <button class="btn btn-success" *ngIf="!videoUrl && temporaryVideoBlob" (click)="uploadTemporaryVideo()">
          â˜ï¸ Envoyer VidÃ©o
        </button>
        <div class="dropdown" *ngIf="!videoUrl && (isVideoInitialized || selectedVideoFile)" #csvDropdown>
          <button class="btn btn-success dropdown-toggle" type="button" (click)="toggleCsvDropdown()" aria-expanded="false">
            ğŸ“Š Exporter DonnÃ©es CSV
          </button>
          <ul class="dropdown-menu" [class.show]="isCsvDropdownOpen" aria-labelledby="csvDropdown">
            <li><a class="dropdown-item" (click)="downloadPoseCSV()">Pose Data (Download)</a></li>
            <li><a class="dropdown-item" (click)="uploadPoseCSV()">Pose Data (Upload)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" (click)="downloadFaceCSV()">Face Data (Download)</a></li>
            <li><a class="dropdown-item" (click)="uploadFaceCSV()">Face Data (Upload)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" (click)="downloadHandsCSV()">Hands Data (Download)</a></li>
            <li><a class="dropdown-item" (click)="uploadHandsCSV()">Hands Data (Upload)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" (click)="downloadAllCSV()">Tout Exporter (Download)</a></li>
            <li><a class="dropdown-item" (click)="uploadAllCSV()">Tout Exporter (Upload)</a></li>
          </ul>        </div>
      </div>
    </section>

    <!-- 3D Model Section -->
    <section class="three-d-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2>ğŸ‘¤ Personnage 3D Interactif</h2>
        <button class="btn btn-info" (click)="toggleFull3DView()">
          {{ showFull3DView ? 'â—€ï¸ Retour Vue Normale' : 'ğŸ¬ Vue Plein Ã‰cran' }}
        </button>
      </div>
      <div class="three-d-container" #threeDContainer></div>
      <div class="model-info" *ngIf="showModelInfo">
        <p>Ce personnage 3D rÃ©agit aux mouvements de votre corps. Cliquez sur le modÃ¨le pour afficher/masquer cette information.</p>
        <p>Position X: {{ modelPosition.x | number:'1.2-2' }}, Y: {{ modelPosition.y | number:'1.2-2' }}, Z: {{ modelPosition.z | number:'1.2-2' }}</p>
      </div>
    </section>

    <!-- Section to display generated video after analysis -->
    <section class="generated-video-section" *ngIf="storedVideoUrl">
      <h2>ğŸ¥ VidÃ©o GÃ©nÃ©rÃ©e aprÃ¨s Analyse</h2>
      <div class="video-display">
        <video [src]="storedVideoUrl" controls class="generated-video"></video>
        <div class="video-info">
          <p>VidÃ©o stockÃ©e dans les ressources aprÃ¨s l'analyse</p>
          <button class="btn btn-info" (click)="downloadStoredVideo()">ğŸ“¥ TÃ©lÃ©charger VidÃ©o</button>
        </div>
      </div>
    </section>

    <section class="analysis-section">
      <h2>ğŸ“Š RÃ©sultats de l'Analyse</h2>

      <div class="analysis-grid">
        <!-- Posture -->
        <div class="analysis-card posture-card">
          <h3>ğŸ“ Analyse Posture</h3>
          <div class="confidence-bar">
            <div class="confidence-fill" [style.width.%]="getPoseConfidence()">
              {{ getPoseConfidence() }}%
            </div>
          </div>
          <div class="status-text">{{ getPoseStatus() }}</div>
          <div class="details" *ngIf="bodyAnalysis?.pose">
            <p class="detail-item">{{ getPoseDetails() }}</p>
          </div>
          <div class="no-data" *ngIf="!bodyAnalysis?.pose">Pas de pose</div>
        </div>

        <!-- Visage -->
        <div class="analysis-card face-card">
          <h3>ğŸ˜Š Analyse Visage</h3>
          <div class="status-text">{{ getFaceStatus() }}</div>
          <div class="expression" *ngIf="bodyAnalysis?.face">
            <p>Expression: <strong>{{ getFaceExpression() }}</strong></p>
            <p>Mouvement: <strong>{{ getDetectedMovement() }}</strong></p>
          </div>
          <div class="no-data" *ngIf="!bodyAnalysis?.face">Aucune donnÃ©e</div>
        </div>

        <!-- Mains -->
        <div class="analysis-card hands-card">
          <h3>ğŸ‘‹ Analyse Mains</h3>
          <div class="status-text">{{ getHandsStatus() }}</div>
          <div class="gestures" *ngIf="bodyAnalysis?.hands?.left || bodyAnalysis?.hands?.right">
            <p>Gestes: <strong>{{ getHandsGestures() }}</strong></p>
          </div>
          <div class="no-data" *ngIf="!bodyAnalysis?.hands?.left && !bodyAnalysis?.hands?.right">
            Aucune main
          </div>
        </div>

        <!-- SystÃ¨me -->
        <div class="analysis-card system-card">
          <h3>ğŸ“Š Ã‰tat du SystÃ¨me</h3>
          <div class="system-status">
            <div class="status-row">
              <span class="status-key">CamÃ©ra</span>
              <span class="status-value">{{ getSystemStatus().camera }}</span>
            </div>
            <div class="status-row">
              <span class="status-key">Analyse</span>
              <span class="status-value">{{ getSystemStatus().analysis }}</span>
            </div>
            <div class="status-row">
              <span class="status-key">FPS</span>
              <span class="status-value">{{ getSystemStatus().fps }}</span>
            </div>
            <div class="status-row">
              <span class="status-key">Pose</span>
              <span class="status-value">{{ getSystemStatus().posture }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="video-footer">
    <div class="info-box">
      <p>
        <strong>Confiance Posture:</strong> {{ getPoseConfidence() }}% | 
        <strong>Confiance Visage:</strong> {{ getFaceConfidence() }}% | 
        <strong>Mouvement DÃ©tectÃ©:</strong> {{ getDetectedMovement() }}
      </p>
      <p>
        <a routerLink="/data" class="data-link">ğŸ“Š Voir les donnÃ©es capturÃ©es</a>
      </p>
    </div>
  </footer>
</div>